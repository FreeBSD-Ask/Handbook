# 16.10.TCP 封装器（TCP Wrapper）


TCP Wrappers 是一种基于主机的网络访问控制系统。通过在实际的网络服务之前拦截传入的网络请求，TCP Wrappers 根据预定义的规则评估源 IP 地址是否被允许访问或被拒绝。

然而，尽管 TCP Wrappers 提供了基本的访问控制，但不应被视为更强大安全措施的替代品。为了全面保护，建议结合使用防火墙、适当的用户身份验证实践和入侵检测系统。

### 16.10.1. 初始配置

TCP Wrappers 默认在 [inetd(8)](https://man.freebsd.org/cgi/man.cgi?query=inetd&sektion=8&format=html) 中启用。因此，第一步是启用 [inetd(8)](https://man.freebsd.org/cgi/man.cgi?query=inetd&sektion=8&format=html)，执行以下命令：

```
# sysrc inetd_enable="YES"
# service inetd start
```

然后，正确配置 **/etc/hosts.allow**。

>**警告**
>
> 不同于其他实现，FreeBSD 中 **hosts.deny** 的使用已被弃用。所有配置选项应放在 **/etc/hosts.allow** 中。

在最简单的配置中，守护进程的连接策略设置为允许或阻止，具体取决于 **/etc/hosts.allow** 中的选项。FreeBSD 的默认配置是允许所有连接到由 inetd 启动的守护进程。

基本配置通常采用 `daemon : address : action` 形式，其中 `daemon` 是 inetd 启动的守护进程，`address` 是有效的主机名、IP 地址或用括号括起来的 IPv6 地址 ([ ])，`action` 是 `allow` 或 `deny`。TCP Wrappers 使用“先匹配规则”的语义，意味着配置文件会从头开始扫描匹配的规则。一旦找到匹配项，规则会被应用，搜索过程停止。

例如，要允许通过 [mail/qpopper](https://cgit.freebsd.org/ports/tree/mail/qpopper/) 守护进程进行 POP3 连接，可以将以下行添加到 **/etc/hosts.allow**：

```
# 这是允许 POP3 连接所必需的：
qpopper : ALL : allow
```

每次编辑此文件时，请重新启动 inetd：

```
# service inetd restart
```

### 16.10.2. 高级配置

TCP Wrappers 提供了高级选项，可以更好地控制连接的处理方式。在某些情况下，可能需要对某些主机或守护进程连接返回评论。在其他情况下，可能需要记录日志条目或向管理员发送电子邮件。还有些情况可能需要仅对本地连接使用某个服务。所有这些都可以通过使用通配符、扩展字符和外部命令执行来实现。要了解更多关于通配符及其相关功能的信息，请参阅 [hosts_access(5)](https://man.freebsd.org/cgi/man.cgi?query=hosts_access&sektion=5&format=html)。



## 16.11. 访问控制列表 (ACL)

访问控制列表（ACL）扩展了传统的 UNIX® 文件权限，允许在每个文件或目录的基础上对用户和组提供细粒度的访问控制。每个 ACL 条目定义一个用户或组以及相关的权限，如读取、写入和执行。FreeBSD 提供了命令 [getfacl(1)](https://man.freebsd.org/cgi/man.cgi?query=getfacl&sektion=1&format=html) 和 [setfacl(1)](https://man.freebsd.org/cgi/man.cgi?query=setfacl&sektion=1&format=html) 来管理 ACL。

ACL 在需要比标准权限更具体访问控制的场景中非常有用，通常用于多用户环境或共享托管。然而，复杂性可能是不可避免的，因此需要仔细规划，以确保提供所需的安全性。

>**注意**
>
>FreeBSD 支持在 UFS 和 OpenZFS 中实现 NFSv4 ACL。请注意，某些参数在 [setfacl(1)](https://man.freebsd.org/cgi/man.cgi?query=setfacl&sektion=1&format=html) 命令中仅适用于 POSIX ACL，其他则适用于 NFSv4 ACL。

### 16.11.1. 启用 UFS 中的 ACL 支持

ACL 通过挂载时的管理标志 `acls` 启用，可以在 **/etc/fstab** 中添加此标志。

因此，需要访问 **/etc/fstab**，并在选项部分添加 `acls` 标志，如下所示：

```
# 设备        挂载点          文件系统类型    选项       Dump      Pass#
/dev/ada0s1a    /                 ufs       rw,acls     1         1
```

### 16.11.2. 获取 ACL 信息

可以使用 [getfacl(1)](https://man.freebsd.org/cgi/man.cgi?query=getfacl&sektion=1&format=html) 检查文件或目录的 ACL。

例如，要查看 **~/test** 文件的 ACL 设置，请执行以下命令：

```
% getfacl test
```

如果使用 NFSv4 ACL，输出应类似于以下内容：

```
# 文件: test
# 所有者: freebsduser
# 组: freebsduser
            owner@:rw-p--aARWcCos:-------:allow
            group@:r-----a-R-c--s:-------:allow
         everyone@:r-----a-R-c--s:-------:allow
```

如果使用 POSIX.1e ACL，输出应类似于以下内容：

```
# 文件: test
# 所有者: freebsduser
# 组: freebsduser
user::rw-
group::r--
other::r--
```

## 16.11.3. 操作 ACL

[setfacl(1)](https://man.freebsd.org/cgi/man.cgi?query=setfacl&sektion=1&format=html) 可用于向文件或目录添加、修改或删除 ACL。

如上所述，某些 [setfacl(1)](https://man.freebsd.org/cgi/man.cgi?query=setfacl&sektion=1&format=html) 的参数不适用于 NFSv4 ACL，反之亦然。本节介绍如何执行适用于 POSIX ACL 和 NFSv4 ACL 的命令，并展示两者的示例。

例如，要设置 POSIX.1e 默认 ACL 的强制元素：

```
% setfacl -d -m u::rwx,g::rx,o::rx,mask::rwx directory
```

此示例为文件所有者的 POSIX.1e ACL 条目设置读、写和执行权限，并为文件上的邮件组设置读写权限：

```
% setfacl -m u::rwx,g:mail:rw file
```

要在 NFSv4 ACL 中执行与上一个示例相同的操作：

```
% setfacl -m owner@:rwxp::allow,g:mail:rwp::allow file
```

要从 POSIX.1e ACL 中删除所有 ACL 条目，但保留文件的三个必需条目：

```
% setfacl -bn file
```

要从 NFSv4 ACL 中删除所有 ACL 条目：

```
% setfacl -b file
```

有关这些命令的选项，请参考 [getfacl(1)](https://man.freebsd.org/cgi/man.cgi?query=getfacl&sektion=1&format=html) 和 [setfacl(1)](https://man.freebsd.org/cgi/man.cgi?query=setfacl&sektion=1&format=html)。


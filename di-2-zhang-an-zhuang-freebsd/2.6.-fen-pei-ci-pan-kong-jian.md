# 2.6.分配磁盘空间

下一个菜单用于选择分配磁盘空间的方法。

![Shows the different partition options Example Manual](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-zfs-partmenu.png)

十、分区选择

bsdinstall 为用户提供了四种分配磁盘空间的方法：

* Auto (ZFS) 分区 在 ZFS 系统中创建根目录，并为引导环境提供了可选的 GELI 加密支持。
* Auto (UFS) 分区自动设置磁盘分区，使用 UFS 文件系统。
* Manual 分区允许高级用户从菜单选项中创建自定义分区。
* Shell 打开 Shell 提示符，高级用户可以使用诸如 gpart(8)、fdisk(8)和 bsdlabel(8)之类的命令行实用程序创建自定义分区。

本部分描述了在布置磁盘分区时要考虑的内容。然后演示了如何使用不同的分区方法。

### 2.6.1. 分区布局规划

文件系统的默认分区布局是一个文件系统包含了整个系统。当使用 UFS 时，如果有足够的磁盘空间或多个磁盘，可以考虑使用多个文件系统。在布局文件系统时，请记住硬盘从外部轨道到内部传输数据速度更快。因此，较小且访问较频繁的文件系统应放在驱动器的外侧，而像 /usr 这样较大的分区应放在磁盘的内部部分。最好按照类似的顺序创建分区： /，交换空间，/var 和 /usr。

/var 分区的大小反映了预期机器的使用方式。此分区用于保存邮箱、日志文件和打印机队列。根据用户数量和日志文件保存时间，邮箱和日志文件的大小可能会无法预料地增长。一般来说，大多数用户在 /var 中很少需要超过约 1 GB 的空闲磁盘空间。

|  | 有时，/var/tmp 需要大量的磁盘空间。当安装新软件时，打包工具会在 /var/tmp 下提取软件包的临时副本。大型软件包（如 Firefox 或 LibreOffice）如果 /var/tmp 所在的磁盘空间不足，可能会安装起来有些棘手。|
| -- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

" /usr 分区包含支持系统的许多文件，包括 FreeBSD Ports 和系统源代码。建议为此分区至少提供 2 GB 的空间。还要注意，默认情况下，用户的主目录位于 /usr/home，但可以放在其他分区上。默认情况下，/home 是指向 /usr/home 的符号链接。

在选择分区大小时，请牢记空间需求。当一个分区中空间用尽而另一个分区几乎没有使用时可能会很麻烦。

作为经验法则，交换分区的大小应该约为物理内存（RAM）大小的两倍。具有较小内存（适用于更大内存配置的情况）的系统可通过增加交换空间而获得更好的性能。配置过少的交换空间可能导致虚拟内存页面扫描代码的效率低下，并且在日后增加虚拟内存时可能会出现问题。

在具有多个 SCSI 磁盘或在不同控制器上运行的多个 IDE 磁盘的较大设备上，建议为每个驱动器都配置一个交换空间，最多配置四个驱动器。交换分区的大小应大致相同。内核可以处理任意大小，但内部数据结构的扩展可到最大交换分区的 4 倍。保持交换分区的大小相同（相近）将允许内核在磁盘间最佳地分布交换空间。大的交换空间可能会引起关于总配置交换的内核警告信息。可通过增加用于跟踪交换分配的内存量来提高限制，可以遵循警告消息中的说明。在被迫重启之前，能够从失控的程序中恢复。

通过正确地对系统进行分区，可以防止小型写入密集分区中引入的碎片化现象扩散到大部分读取分区。将写入负载较重的分区保持在靠近磁盘边缘的位置，将增加在发生最频繁的分区中的 I/O 性能。虽然可能需要较大分区中的 I/O 性能，但将它们移动到磁盘边缘不会比将 /var 移动到边缘带来显著的性能改进。

### 2.6.2. 使用 UFS 进行引导分区

当选择了该方法后，菜单中将显示可用的磁盘。如果接入了多个磁盘，请选择要把 FreeBSD 安装到哪个磁盘中。

![Shows the list of disks on which FreeBSD can be installed](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-part-guided-disk.png)

从多个磁盘中进行选择

选择磁盘后，下一个菜单会提示安装到整个磁盘还是使用空闲空间创建分区。如果选择整个磁盘，则会自动创建填满整个磁盘的一般分区布局。选择分区则会从磁盘上未使用的空间创建分区布局。

![Menu asking the user if he wants to use all the available space on the disk or wants to make a partition](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-part-entire-part.png)

选择整个磁盘或分区

选择完整磁盘选项后，bsdinstall 显示一个对话框，指示磁盘将被格式化。

![Menu indicating the user that all data on the disk will be deleted and asking for confirmation](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-ufs-warning.png)

 确认图 13。

下个菜单会列出一个可用分区方案类型的列表。对于 amd64 计算机，通常 GPT 是最合适的选择。不兼容 GPT 的旧计算机应该使用 MBR。其他分区方案通常用于罕见的或老的计算机。有关更多信息，请参阅分区方案。

![Menu showing the user the different the different types of partition that exist and requesting one of them](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-part-manual-partscheme.png)

选择分区方案图

分区布局创建后，请进行复审以确保满足安装需求。选择“还原”将重置分区为其原始值。按“自动”将重新创建自动 FreeBSD 分区。分区也可手动创建、修改或删除。分区设置正确后，选择“完成”继续安装。

![Menu showing created partitions](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-part-review.png)

查看创建的分区图

在磁盘配置完成后，下一个菜单提供了在选择驱动器格式化之前进行更改的最后机会。如果需要进行更改，请选择“返回”以返回到主分区菜单。还原并退出可在不对驱动器进行任何更改的情况下退出安装程序。否则，请选择“提交”开始安装过程。

![Menu indicating to the user that all changes will be written to disk and informing that if he decides to continue the existing data will be permanently deleted](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-final-confirmation.png)

图 16. 最终确认

若要继续安装过程，请转至获取发布文件。

### 2.6.3. 手动分区

选择此方法将打开分区编辑器:

![Menu showing the Partition Editor](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-part-manual-create.png)

图 17. 手动创建分区

突出显示安装驱动器（在此示例中为 ada0 ），然后选择“创建”以显示可用分区方案的菜单：

![Menu showing the different kind of partition schemes](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-part-manual-partscheme.png)

图 18.手动创建分区

GPT 通常是适用于 amd64 计算机的最佳选择。与 GPT 不兼容的较老的计算机应使用 MBR。其他分区方案通常用于不常见或较旧的计算机。

| | | | --- | --- |表 1.分区方案

| 缩写 | 说明                                                                            |
| ------ | ----------------------------------------------------------------------------------- |
| APM  | 苹果分区表，适用于 PowerPC®。                                     |
| BSD  | BSD 标签且无 MBR，有时称为危险专用模式，因为非 BSD 磁盘工具可能无法识别它。|
| GPT  | GUID 分区表。                                                     |
| MBR  | 主引导记录。                                                       |

在选择和创建分区方案后，再次选择创建以创建分区。按 Tab 键可用于将焦点放在字段上（在循环中依次查看，和 之后）。

![Menu requesting type](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-part-manual-addpart.png)

图 19。手动创建分区

标准的 FreeBSD GPT 安装至少使用三个分区，包括 UFS 或 ZFS：

* freebsd-boot 或 efi - 包含 FreeBSD 引导代码。
* freebsd-ufs - FreeBSD UFS 文件系统。
* freebsd-zfs - FreeBSD ZFS 文件系统。有关 ZFS 的更多信息，请参阅 Z 文件系统（ZFS）。
* freebsd-swap - FreeBSD 交换空间。

有关可用 GPT 分区类型的说明，请参阅 gpart(8)。

可以创建多个文件系统分区。一些人喜欢传统布局，为 / 、 /var 、 /tmp 和 /usr 分别创建单独的分区。

|  | 请注意，只要设备内存够大，可以在以后把 /tmp 改为基于内存的文件系统（tmpfs(5)）。|
| -- | -------------------------------------------------------------------------------- |

参见《创建传统拆分文件系统分区》中的示例。

使用常见缩写输入 Size ：K 代表千字节，M 代表兆字节，G 代表吉字节。

|  | 适当的扇区对齐可提供最佳性能，使分区大小成为 4K 字节的整数倍有助于确保在具有 512 字节或 4K 字节扇区的驱动器上进行对齐。通常，分区大小使用 1M 或 1G 的整数倍值是确保每个分区始终从 4K 的整数倍开始的最简便方法。只有一个例外：由于当前引导代码限制，freebsd-boot 分区的大小不应超过 512K。|
| -- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

如果分区包含了文件系统，则需要 Mountpoint。如果只创建了一个 UFS 分区，则挂载点应为 /。

该 Label 是分区将被识别的名称。如果驱动器连接到不同的控制器或端口，驱动器名称或编号可能会有变化，但分区标签不会更改。在文件中（如 /etc/fstab）应引用标签而非驱动器名称和分区编号，以使系统更能兼容硬件更替。当接入磁盘时，GPT 标签会出现在 /dev/gpt/ 中。其他分区方案有不同的标签功能，它们的标签出现在 /dev/ 中的不同目录中。

|  | 在每个分区上使用唯一标签，以避免由相同标签造成的冲突。可以将计算机名称、用途或位置的几个字母添加到标签中。例如，对名为 lab 的计算机上的 UFS 根分区使用 labroot 或 rootfslab。|
| -- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

示例 1. 创建传统的分离式文件系统分区

对于传统的分区布局，其中 /，/var，/tmp 和 /usr 目录是各自单独的分区文件系统，请创建一个 GPT 分区方案，然后如下创建分区。所示的分区大小对于 20G 目标磁盘是典型的。如果目标磁盘上有更多空间，较大的交换或 /var 分区可能会有用。这里显示的标签以 ex 为前缀，表示“示例”，但读者应按上面描述的其他唯一标签值使用其他值。

在默认情况下，FreeBSD 的 gptboot 希望第一个 UFS 分区是 / 分区。

| 分区类型 | 大小                   | 挂载点 | 标签 |
| ---------- | ------------------------ | -------- | ------ |
| `freebsd-boot`         | `512K`                       |        |      |
| `freebsd-ufs`         | `2G`                       | `/`       | `exrootfs`     |
| `freebsd-swap`         | `4G`                       |        | `exswap`     |
| `freebsd-ufs`         | `2G`                       | `/var`       | `exvarfs`     |
| `freebsd-ufs`         | `1G`                       | `/tmp`       | `extmpfs`     |
| `freebsd-ufs`         | 接受默认值（剩余磁盘） | `/usr`       | `exusrfs`     |

在创建自定义分区后，选择“完成”以继续安装并转到“获取发行文件”。

### 2.6.4. 使用基于 ZFS 的引导分区指导

此分区模式仅适用于整个磁盘，并将擦除整个磁盘的内容。主 ZFS 配置菜单提供了许多选项，可控制池的创建。

![Menu showing the different options to configure the ZFS pool](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-zfs-menu.png)

图 20. ZFS 分区菜单

这里是此菜单中选项的摘要。

* Install - 使用所选选项继续安装。
* Pool Type/Disks - 配置 Pool Type 和将构成池的磁盘。自动 ZFS 安装程序目前仅支持创建单个顶级 vdev，除非采用条带模式。要创建更复杂的池，请使用 Shell 模式分区的说明来创建池。
* Rescan Devices - 重新填充可用磁盘列表。
* Disk Info - 该菜单可用于检查每个磁盘，包括其分区表和其他各种信息，例如设备型号和序列号（如有）。
* Pool Name - 确定池的名称。默认名称为 zroot。
* Force 4K Sectors? - 强制使用 4K 扇区。默认情况下，安装程序将自动创建与 4K 边界对齐的分区，并强制 ZFS 使用 4K 扇区。即使是 512 字节扇区磁盘，这也是安全的，并且还有一个额外的好处，即确保在将来可以为 512 字节磁盘添加 4K 扇区磁盘，无论是作为额外的存储空间还是作为替代已损坏磁盘。按回车键选择是否激活。
* Encrypt Disks? - 加密磁盘允许用户使用 GELI 加密磁盘。有关磁盘加密的更多信息，请参阅“使用 geli 进行磁盘加密”。按回车键选择是否激活。
* Partition Scheme - 选择分区方案。在大多数情况下，GPT 是推荐选项。按回车键在不同选项之间进行选择。
* Swap Size - 确定交换空间的数量。
* Mirror Swap? - 是否要在磁盘之间镜像交换。请注意，启用镜像交换将破坏崩溃转储。按回车键以激活或不激活。
* Encrypt Swap? - 是否要加密交换空间。将使用临时密钥加密交换空间，每次系统启动时都会重新生成该密钥，并在重新启动时丢弃密钥。按回车键选择是否激活。关于交换加密空间的更多信息请参阅“加密交换空间”。

选择 T 以配置 Pool Type 和将构成池的磁盘。

![Menu requesting the Virtual Device type Ex stripe](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-zfs-vdev_type.png)

图 21。ZFS 池 类型

这里是可以在此菜单中选择的 Pool Type 的摘要：

* stripe - 条带提供所有连接设备的最大存储空间，但没有冗余。如果仅有一个磁盘出现故障，池中的数据将无法恢复地丢失。
* mirror - 镜像将完整拷贝存储在每个磁盘上的所有数据。镜像提供良好的读取性能，因为数据可以并行从所有磁盘读取。写入性能较慢，因为数据必须写入池中的所有磁盘。允许除一个磁盘以外的所有磁盘故障。此选项至少需要两个磁盘。
* raid10 - 条带镜像。提供最佳性能，但存储量最少。此选项至少需要偶数个磁盘和至少四个磁盘。
* raidz1 - 单冗余 RAID。允许一个磁盘同时故障。此选项至少需要三个磁盘。
* raidz2 - 双冗余 RAID。允许两个磁盘同时失败。此选项至少需要四个磁盘。
* raidz3 - 三重冗余 RAID。允许三个磁盘同时失败。此选项至少需要五个磁盘。

选择了 Pool Type 后，将显示一个可用磁盘列表，并提示用户选择一个或多个磁盘来组成池。然后验证配置以确保选择了足够的磁盘。如果验证失败，请选择返回到磁盘列表或更改 Pool Type。

![Menu requesting how many disks will be added to the pool](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-zfs-disk_select.png)

选择磁盘图

![Menu indicating that not enough disks have been selected](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-zfs-vdev_invalid.png)

无效选择图

如果列表中缺少一个或多个磁盘，或者在安装程序启动后附加了磁盘，请选择 - 重新扫描设备以重新显示可用磁盘列表。

![Device rescan](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-zfs-rescan-devices.png)

图 24。重新扫描设备

为了避免意外擦除错误的磁盘，可以使用磁盘信息菜单查看每个磁盘，包括其分区表和其他各种信息，如设备型号和序列号（如果有）。

![Menu showing the information of the partitions](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-zfs-disk_info.png)

图 25。分析磁盘

选择 N 来配置 Pool Name。输入所需名称，然后选择建立它或返回到主菜单并保留默认名称。

![Menu requesting the name of the pool](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-zfs-pool-name.png)

图 26. 池名称

选择 S 来设置交换空间的数量。输入所需的交换空间数量，然后选择建立它或返回到主菜单并保留默认数量。

![Menu requesting the amount of swap memory](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-zfs-swap-amount.png)

数额交换

所有选项均设置为所需数值后，请在菜单顶部选择>>>安装选项。然后安装程序在销毁所选驱动器的内容以创建 ZFS 池之前，提供最后一次取消的机会。

![Menu indicating to the user that the data will be lost](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-zfs-warning.png)

最后的机会

如果启用了 GELI 磁盘加密，安装程序将两次提示输入用于加密磁盘的密码。然后开始初始化加密。

![Menu requesting the password to encrypt the devices](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-zfs-geli_password.png)

第 29.磁盘加密密码

![Menu showing that the encryption is initializing](https://docs.freebsd.org/images/books/handbook/bsdinstall/bsdinstall-zfs-init-encription.png)

第 30.初始化加密

安装然后正常进行。要继续安装，请转到获取分发文件。

### 2.6.5. Shell 模式分区

在创建高级安装时，bsdinstall 分区菜单可能无法提供所需的灵活度。高级用户可以从分区菜单中选择 Shell 选项，以手动分区驱动器，创建文件系统，写入 /tmp/bsdinstall_etc/fstab，并在 /mnt 下挂载文件系统。完成后，输入 exit 返回 bsdinstall 并继续安装。
